# Backend Project - APIs Archives

## REST API Endpoints Documentation

*Added on: 2023-07-30 10:15:33*

This document provides a comprehensive overview of all REST API endpoints available in the backend service.

### Authentication Endpoints

#### POST /api/auth/login

Authenticates a user and returns a JWT token.

**Request Body:**
```json
{
  "email": "user@example.com",
  "password": "securepassword"
}
```

**Response (200 OK):**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": "123",
    "email": "user@example.com",
    "name": "John Doe",
    "role": "user"
  }
}
```

**Error Responses:**
- 401 Unauthorized: Invalid credentials
- 400 Bad Request: Missing required fields

#### POST /api/auth/register

Registers a new user.

**Request Body:**
```json
{
  "email": "newuser@example.com",
  "password": "securepassword",
  "name": "Jane Doe"
}
```

**Response (201 Created):**
```json
{
  "id": "456",
  "email": "newuser@example.com",
  "name": "Jane Doe",
  "role": "user",
  "createdAt": "2023-07-30T10:15:33Z"
}
```

**Error Responses:**
- 409 Conflict: Email already exists
- 400 Bad Request: Invalid data or missing required fields

### User Endpoints

#### GET /api/users/me

Returns the currently authenticated user's profile.

**Headers:**
- Authorization: Bearer {token}

**Response (200 OK):**
```json
{
  "id": "123",
  "email": "user@example.com",
  "name": "John Doe",
  "role": "user",
  "createdAt": "2023-06-15T08:30:22Z",
  "updatedAt": "2023-07-29T14:10:45Z"
}
```

**Error Responses:**
- 401 Unauthorized: Missing or invalid token
- 403 Forbidden: Insufficient permissions

### Product Endpoints

#### GET /api/products

Returns a paginated list of products.

**Query Parameters:**
- page (optional): Page number (default: 1)
- limit (optional): Items per page (default: 20)
- category (optional): Filter by category
- search (optional): Search term for product name

**Response (200 OK):**
```json
{
  "items": [
    {
      "id": "prod-123",
      "name": "Product One",
      "description": "Description for product one",
      "price": 29.99,
      "category": "electronics",
      "imageUrl": "https://example.com/images/product-one.jpg"
    },
    ...
  ],
  "total": 150,
  "page": 1,
  "limit": 20,
  "totalPages": 8
}
```

#### GET /api/products/{id}

Returns a single product by ID.

**Response (200 OK):**
```json
{
  "id": "prod-123",
  "name": "Product One",
  "description": "Description for product one",
  "price": 29.99,
  "category": "electronics",
  "imageUrl": "https://example.com/images/product-one.jpg",
  "inventory": 42,
  "createdAt": "2023-05-10T09:20:34Z",
  "updatedAt": "2023-07-15T11:30:12Z"
}
```

**Error Responses:**
- 404 Not Found: Product not found

### Order Endpoints

#### POST /api/orders

Creates a new order.

**Headers:**
- Authorization: Bearer {token}

**Request Body:**
```json
{
  "items": [
    {
      "productId": "prod-123",
      "quantity": 2
    },
    {
      "productId": "prod-456",
      "quantity": 1
    }
  ],
  "shippingAddress": {
    "street": "123 Main St",
    "city": "Exampleville",
    "state": "CA",
    "zipCode": "12345",
    "country": "USA"
  },
  "paymentMethod": "credit_card"
}
```

**Response (201 Created):**
```json
{
  "id": "order-789",
  "userId": "123",
  "items": [
    {
      "productId": "prod-123",
      "name": "Product One",
      "price": 29.99,
      "quantity": 2,
      "subtotal": 59.98
    },
    {
      "productId": "prod-456",
      "name": "Product Two",
      "price": 49.99,
      "quantity": 1,
      "subtotal": 49.99
    }
  ],
  "totalAmount": 109.97,
  "status": "pending",
  "shippingAddress": {
    "street": "123 Main St",
    "city": "Exampleville",
    "state": "CA",
    "zipCode": "12345",
    "country": "USA"
  },
  "paymentMethod": "credit_card",
  "createdAt": "2023-07-30T10:15:33Z"
}
```

**Error Responses:**
- 400 Bad Request: Invalid data or missing required fields
- 401 Unauthorized: Missing or invalid token
- 409 Conflict: Insufficient inventory

---

## API Rate Limiting Implementation

*Added on: 2023-08-02 15:20:45*

We implemented rate limiting for the API to prevent abuse and ensure service stability.

### Implementation Details

Rate limiting is implemented using Redis and the token bucket algorithm:

1. Each API client is identified by API key or IP address
2. Each client has a "bucket" with tokens that refill at a constant rate
3. Each API request consumes one token
4. When a client's bucket is empty, requests are rejected

### Rate Limit Configuration

Different rate limits are applied based on the endpoint and user role:

| Endpoint | Anonymous | Regular User | Premium User |
|----------|-----------|--------------|--------------|
| Auth     | 10/min    | 20/min       | 50/min       |
| Products | 30/min    | 100/min      | 300/min      |
| Orders   | 5/min     | 30/min       | 100/min      |

### Headers

Rate limit information is included in the response headers:

- `X-RateLimit-Limit`: The maximum number of requests allowed in a time window
- `X-RateLimit-Remaining`: The number of requests remaining in the current time window
- `X-RateLimit-Reset`: The time at which the rate limit will reset (Unix timestamp)

### Error Response

When a client exceeds their rate limit, a 429 Too Many Requests response is returned:

```json
{
  "error": "Too Many Requests",
  "message": "Rate limit exceeded. Please try again later.",
  "retryAfter": 30
}
```

### Redis Implementation

The rate limiting functionality is implemented using Redis sorted sets:

```typescript
// Pseudocode for the rate limiting middleware
async function rateLimitMiddleware(req, res, next) {
  const clientId = req.apiKey || req.ip;
  const endpoint = req.path.split('/')[2]; // e.g., 'auth', 'products'
  const userRole = req.user?.role || 'anonymous';
  
  const limit = getRateLimit(endpoint, userRole);
  const window = 60; // 1 minute in seconds
  
  const currentTime = Math.floor(Date.now() / 1000);
  const redisKey = `ratelimit:${clientId}:${endpoint}`;
  
  // Remove tokens older than the window
  await redis.zremrangebyscore(redisKey, 0, currentTime - window);
  
  // Count current tokens
  const currentTokens = await redis.zcard(redisKey);
  
  if (currentTokens >= limit) {
    // Rate limit exceeded
    const oldestToken = await redis.zrange(redisKey, 0, 0, 'WITHSCORES');
    const resetTime = parseInt(oldestToken[1]) + window;
    const retryAfter = resetTime - currentTime;
    
    res.set('X-RateLimit-Limit', limit.toString());
    res.set('X-RateLimit-Remaining', '0');
    res.set('X-RateLimit-Reset', resetTime.toString());
    res.set('Retry-After', retryAfter.toString());
    
    return res.status(429).json({
      error: 'Too Many Requests',
      message: 'Rate limit exceeded. Please try again later.',
      retryAfter
    });
  }
  
  // Add current request to the sorted set
  await redis.zadd(redisKey, currentTime, `${currentTime}-${Math.random()}`);
  
  // Set headers
  res.set('X-RateLimit-Limit', limit.toString());
  res.set('X-RateLimit-Remaining', (limit - currentTokens - 1).toString());
  res.set('X-RateLimit-Reset', (currentTime + window).toString());
  
  next();
}
```

--- 